version: 1.0

services:
  - serviceName: virtual-finance-backend
    sourceConfiguration:
      codeRepository:
        repositoryUrl: "https://github.com/virtualfinance1992/Virtual-Finance"
        sourceCodeVersion:
          type: BRANCH
          value: main
        codeConfiguration:
          configurationSource: REPOSITORY
          codeConfigurationValues:
            runtime: PYTHON_3_11

            # BUILD COMMAND with explicit echo markers for logging
            buildCommand: |
              echo "=== Step 1: Change directory to backend ===" &&
              cd backend &&

              echo "=== Step 2: Upgrade pip ===" &&
              python -m pip install --upgrade pip &&
              echo "=== pip upgraded successfully ===" &&

              echo "=== Step 3: Install Python dependencies ===" &&
              pip install -r requirements.txt &&
              echo "=== Dependencies installed ===" &&

              echo "=== Step 4: Run migrations ===" &&
              python manage.py migrate --no-input &&
              echo "=== Migrations applied ===" &&

              echo "=== Step 5: Collect static files ===" &&
              python manage.py collectstatic --no-input &&
              echo "=== Static files collected ==="

            # START COMMAND: launch Django via Gunicorn on port 8000
            startCommand: gunicorn virtual_finance.wsgi:application --bind 0.0.0.0:8000

            port: "8000"

    instanceConfiguration:
      cpu: "1024"
      memory: "2048"

    healthCheckConfiguration:
      protocol: HTTP
      path: "/"
      interval: 10
      timeout: 5
      healthyThreshold: 1
      unhealthyThreshold: 5

    environment:
      - name: DJANGO_SECRET_KEY
        value: "<YOUR-DJANGO-SECRET-KEY>"
      - name: DJANGO_DEBUG
        value: "False"
      - name: DJANGO_ALLOWED_HOSTS
        value: "*"
      - name: DB_NAME
        value: "Virtual-Finance"
      - name: DB_USER
        value: "postgres"
      - name: DB_PASSWORD
        value: "<YOUR-DB-PASSWORD>"
      - name: DB_HOST
        value: "<YOUR-RDS-ENDPOINT>.rds.amazonaws.com"
      - name: DB_PORT
        value: "5432"

    tags:
      - key: Environment
        value: Production
