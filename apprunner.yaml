version: 1.0

services:
  - serviceName: erp_virtualfinance_backend
    sourceConfiguration:
      codeRepository:
        repositoryUrl: "https://github.com/virtualfinance1992/Virtual-Finance"
        sourceCodeVersion:
          type: BRANCH
          value: main
        codeConfiguration:
          configurationSource: REPOSITORY
          codeConfigurationValues:
            runtime: PYTHON_3_11
            buildCommand: |
              echo "=== Step 1: Change directory to backend ===" &&
              cd backend &&
              echo "=== Step 2: Install Python dependencies ===" &&
              pip install -r requirements.txt &&
              echo "=== Step 3: Run migrations ===" &&
              python manage.py migrate --no-input &&
              echo "=== Step 4: Collect static files ===" &&
              python manage.py collectstatic --no-input &&
              echo "=== Build complete ==="
            startCommand: gunicorn virtual_finance.wsgi:application --bind 0.0.0.0:8000
            port: "8000"
    instanceConfiguration:
      cpu: "1024"
      memory: "2048"
    healthCheckConfiguration:
      protocol: HTTP
      path: "/"
      interval: 10
      timeout: 5
      healthyThreshold: 1
      unhealthyThreshold: 5
    environment:
      - name: DJANGO_SECRET_KEY
        value: "<YOUR-DJANGO-SECRET-KEY>"
      - name: DJANGO_DEBUG
        value: "False"
      - name: DJANGO_ALLOWED_HOSTS
        value: "*"
      - name: DB_NAME
        value: "Virtual-Finance"
      - name: DB_USER
        value: "postgres"
      - name: DB_PASSWORD
        value: "<YOUR-DB-PASSWORD>"
      - name: DB_HOST
        value: "<YOUR-RDS-ENDPOINT>.rds.amazonaws.com"
      - name: DB_PORT
        value: "5432"
    tags:
      - key: Environment
        value: Production


# Edit the file in-place to add a comment at the top
(Get-Content .\apprunner.yaml) |
  ForEach-Object { if ($_.TrimStart() -eq "version: 1.0") { "# noop comment" } ; $_ } |
  Set-Content .\apprunner.yaml
